<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #a6a0c3;
    }
    .card {
      margin: 2rem auto;
      max-width: 700px;
      border-radius: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .card-header {
      background-color: #d4cef1;
      font-weight: bold;
      font-size: 1.3rem;
      text-align: center;
    }
    .form-label {
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
      </div>
      <div class="card-body">
        <form method="post">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</label>
            <input type="datetime-local" class="form-control" name="date" value="{{ date }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label">–¢–∏–ø:</label>
            <div class="d-flex align-items-center gap-2">
              <select name="type" class="form-select flex-grow-1" id="select-type">
                {% for t in types %}
                  <option value="{{ t.id }}" {% if t.id == event.type.id %}selected{% endif %}>{{ t.name }}</option>
                {% endfor %}
              </select>
              <input type="text" class="form-control d-none" id="input-type" placeholder="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ...">
              <button type="button" class="btn btn-outline-primary" id="btn-type" onclick="toggleAddMode('type')">+</button>
              <a href="{% url 'manage_dep_event_types' %}?next={{ request.get_full_path }}" class="btn btn-outline-secondary" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã">üëÅ</a>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <div class="d-flex align-items-center gap-2">
              <select name="name" class="form-select flex-grow-1" id="select-name">
                {% for n in names %}
                  <option value="{{ n.id }}" {% if n.id == event.name.id %}selected{% endif %}>{{ n.name }}</option>
                {% endfor %}
              </select>
              <input type="text" class="form-control d-none" id="input-name" placeholder="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ...">
              <button type="button" class="btn btn-outline-primary" id="btn-name" onclick="toggleAddMode('name')">+</button>
              <a href="{% url 'manage_dep_event_names' %}?next={{ request.get_full_path }}" class="btn btn-outline-secondary" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–∞–∑–≤–∞–Ω–∏—è">üëÅ</a>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</label>
            <div class="d-flex align-items-center gap-2">
              <select name="location" class="form-select flex-grow-1" id="select-location">
                {% for l in locations %}
                  <option value="{{ l.id }}" {% if l.id == event.location.id %}selected{% endif %}>{{ l.name }}</option>
                {% endfor %}
              </select>
              <input type="text" class="form-control d-none" id="input-location" placeholder="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ...">
              <button type="button" class="btn btn-outline-primary" id="btn-location" onclick="toggleAddMode('location')">+</button>
              <a href="{% url 'manage_dep_event_locations' %}?next={{ request.get_full_path }}" class="btn btn-outline-secondary" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞">üëÅ</a>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">–£—Ç–æ—á–Ω–µ–Ω–∏—è:</label>
            <textarea name="description" class="form-control" rows="3">{{ event.description }}</textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">–í—ã–∑—ã–≤–∞–µ–º—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:</label>
            <div class="d-flex flex-wrap gap-3">
              {% for user in users %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="employees" value="{{ user.id }}"
                         id="user_{{ user.id }}"
                         {% if user.id in selected_employees %}checked{% endif %}>
                  <label class="form-check-label" for="user_{{ user.id }}">{{ user.last_name }} {{ user.first_name }}</label>
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="text-center">
            <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <a href="/?scroll_to={{ event.date|date:'Y-m-d' }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const trimmed = cookie.trim();
      if (trimmed.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function toggleAddMode(section) {
  const select = document.getElementById(`select-${section}`);
  const input = document.getElementById(`input-${section}`);
  const btn = document.getElementById(`btn-${section}`);

  if (btn.innerText === '+') {
    select.classList.add('d-none');
    input.classList.remove('d-none');
    btn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  } else {
    const value = input.value.trim();
    if (!value) return;

    fetch(`/department-events/add_${section}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({ name: value })
    })
    .then(res => res.json())
    .then(data => {
      if (data.id && (data.name || data.type || data.location)) {
        const option = document.createElement('option');
        option.value = data.id;
        option.textContent = data.name ?? data.type ?? data.location ?? '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        option.selected = true;
        select.appendChild(option);
        input.value = '';
        input.classList.add('d-none');
        select.classList.remove('d-none');
        btn.innerText = '+';
      }
    });
  }
}
</script>
</body>
</html>