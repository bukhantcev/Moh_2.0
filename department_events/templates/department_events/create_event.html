{% extends "main/layout.html" %}
{% block main %}
<div class="container mt-5 d-flex justify-content-center">
  <div class="card shadow-lg" style="max-width: 700px; width: 100%;">
    <div class="card-header text-center" style="background-color: #d6cef0;">
      <h5 class="fw-bold mb-0">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</h5>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          <input type="datetime-local" class="form-control" name="date" value="{{ date }}">
        </div>
        <div class="mb-3">
          <label class="form-label">–¢–∏–ø</label>
          <div class="d-flex align-items-center gap-2">
            <select name="type" class="form-select flex-grow-1" id="select-type">
              <option value="" disabled {% if not selected_type %}selected{% endif %}>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø...</option>
              {% for t in types %}
                <option value="{{ t.id }}" {% if t.id == selected_type %}selected{% endif %}>{{ t.name }}</option>
              {% endfor %}
            </select>
            <input type="text" class="form-control d-none" id="input-type" placeholder="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø...">
            <button type="button" class="btn btn-outline-primary" id="btn-type" onclick="toggleAddMode('type')">+</button>
            <a href="{% url 'manage_dep_event_types' %}?next={{ request.get_full_path }}" class="btn btn-outline-secondary" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã">üëÅ</a>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <div class="d-flex align-items-center gap-2">
            <select name="name" class="form-select flex-grow-1" id="select-name">
              <option value="" disabled {% if not selected_name %}selected{% endif %}>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...</option>
              {% for n in names %}
                <option value="{{ n.id }}" {% if n.id == selected_name %}selected{% endif %}>{{ n.name }}</option>
              {% endfor %}
            </select>
            <input type="text" class="form-control d-none" id="input-name" placeholder="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
            <button type="button" class="btn btn-outline-primary" id="btn-name" onclick="toggleAddMode('name')">+</button>
            <a href="{% url 'manage_dep_event_names' %}?next={{ request.get_full_path }}" class="btn btn-outline-secondary" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–∞–∑–≤–∞–Ω–∏—è">üëÅ</a>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">–ú–µ—Å—Ç–æ</label>
          <div class="d-flex align-items-center gap-2">
            <select name="location" class="form-select flex-grow-1" id="select-location">
              <option value="" disabled {% if not selected_location %}selected{% endif %}>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ...</option>
              {% for l in locations %}
                <option value="{{ l.id }}" {% if l.id == selected_location %}selected{% endif %}>{{ l.name }}</option>
              {% endfor %}
            </select>
            <input type="text" class="form-control d-none" id="input-location" placeholder="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ...">
            <button type="button" class="btn btn-outline-primary" id="btn-location" onclick="toggleAddMode('location')">+</button>
            <a href="{% url 'manage_dep_event_locations' %}?next={{ request.get_full_path }}" class="btn btn-outline-secondary" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞">üëÅ</a>
          </div>
        </div>
        <div class="mb-3">
          <textarea class="form-control" name="description" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...">{{ description }}</textarea>
        </div>
        <div class="mb-3 d-flex flex-wrap gap-3">
          {% for user in users %}
            <label class="form-check-label d-flex align-items-center gap-1">
              <input class="form-check-input" type="checkbox" name="employees" value="{{ user.id }}"
                     {% if user.id in selected_employees %}checked{% endif %}>
              {{ user.last_name }} {{ user.first_name|slice:":1" }}.
            </label>
          {% endfor %}
        </div>
        <div class="text-center mt-4 d-flex justify-content-center gap-3">
          <button type="submit" class="btn btn-success px-4" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <a href="{{ request.GET.next|default:'/' }}" class="btn btn-outline-secondary px-4">–û—Ç–º–µ–Ω–∞</a>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const typeSelect = document.querySelector('select[name="type"]');
    const nameSelect = document.querySelector('select[name="name"]');
    const locationSelect = document.querySelector('select[name="location"]');
    const saveButton = document.querySelector('button[type="submit"]');

    function toggleSaveButton() {
      const isTypeSelected = typeSelect.value !== '';
      const isNameSelected = nameSelect.value !== '';
      const isLocationSelected = locationSelect.value !== '';
      saveButton.disabled = !(isTypeSelected && isNameSelected && isLocationSelected);
    }

    typeSelect.addEventListener('change', toggleSaveButton);
    nameSelect.addEventListener('change', toggleSaveButton);
    locationSelect.addEventListener('change', toggleSaveButton);

    toggleSaveButton(); // –Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Check if this cookie string begins with the given name
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function toggleSaveButton() {
    const typeSelect = document.querySelector('select[name="type"]');
    const nameSelect = document.querySelector('select[name="name"]');
    const locationSelect = document.querySelector('select[name="location"]');
    const saveButton = document.querySelector('button[type="submit"]');

    const isTypeSelected = typeSelect.value !== '';
    const isNameSelected = nameSelect.value !== '';
    const isLocationSelected = locationSelect.value !== '';
    saveButton.disabled = !(isTypeSelected && isNameSelected && isLocationSelected);
  }

  function toggleAddMode(field) {
    const select = document.getElementById('select-' + field);
    const input = document.getElementById('input-' + field);
    const button = document.getElementById('btn-' + field);

    const isAdding = !input.classList.contains('d-none');

    if (isAdding) {
      const value = input.value.trim();
      if (!value) return;

      const nextParam = new URLSearchParams(window.location.search).get('next');
      const postUrl = `/department-events/add_${field}/` + (nextParam ? `?next=${encodeURIComponent(nextParam)}` : '');
      fetch(postUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ name: value })
      })
      .then(res => res.json())
      .then(data => {
        if (data.id && data.name) {
          const option = new Option(data.name, data.id, true, true);
          select.add(option);
          select.value = data.id;
          toggleSaveButton();
        }
        input.classList.add('d-none');
        select.classList.remove('d-none');
        button.textContent = '+';
      });
    } else {
      input.classList.remove('d-none');
      select.classList.add('d-none');
      input.focus();
      button.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
  }
</script>
{% endblock %}